<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js' lang='en'>
  <!-- <![endif] -->
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Your Website</title>
    <meta content='' name='description'>
    <meta content='Silvano Stralla' name='author'>
    <meta content='3 days' name='revisit-after'>
    <meta content='http://www.myopenid.com/xrds?username=sistrall.myopenid.com' http-equiv='X-XRDS-Location'>
    <link href='http://creativecommons.org/licenses/by/3.0/' rel='license' title='Creative Commons Attribution 3.0 Unported License'>
    <link href='/feed' rel='alternate' title='Atom' type='application/atom+xml'>
    <link href='http://www.myopenid.com/server' rel='openid.server'>
    <link href='http://sistrall.myopenid.com/' rel='openid.delegate'>
    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Ajax enabled comments for Movabletype explained</title>
    <script src="//use.typekit.net/kkz3rzj.js" type="text/javascript"></script>
    <script>try { Typekit.load(); } catch(e) {}</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.css" rel="stylesheet" type="text/css" />
    <link href="/assets/stylesheets/all.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
    <script src="http://webplatform.adobe.com/dropcap.js/dropcap.min.js" type="text/javascript"></script>
    <script src="/assets/javascripts/all.js" type="text/javascript"></script>
  </head>
  <body class='thoughts thoughts_2005 thoughts_2005_05 thoughts_2005_05_17 thoughts_2005_05_17_ajax-enabled-comments-for-movabletype-explained thoughts_2005_05_17_ajax-enabled-comments-for-movabletype-explained_index'>
    <header>
      <div am-header=""><div am-header--container=""><div am-header--logo=""><a href="/"><img src="/assets/images/logo.png" /></a>
      </div>
      <div am-header--name=""><a href="/">sistrall.it</a>
      </div>
      <div am-header--lead=""><p><code>/pensieri s(c|p)arsi dal 2002/</code></p>
      </div>
      </div>
      </div>
    </header>
    <section>
      <div am-content=""><div am-content--container=""><div am-content--content=""><div am-post=""><article>
        <header>
          <div am-post--header=""><div am-post--type=""><p><a href="/thoughts">Post</a></p>
          </div>
          <div am-post--meta=""><p>Pubblicato il <strong>17 maggio 2005</strong></p>
          </div>
          <div am-post--title=""><h2>Ajax enabled comments for Movabletype explained</h2>
          </div>
          </div>
        </header>
      </article>
      <div am-post--content=""><p>Some days ago, I <a href="http://www.sistrall.it/archives/2005/05/07/ajax_enabled_comments_for_movabletype.html">posted</a> about realizing Ajax enabled comments in Movabletype. Here is how.</p>
      <h4>Why Ajax comments</h4>
      <p>When you comment a post on a blog, the page that contains the form you have filled and sent reloads. Instead, using <a href="http://www.adaptivepath.com/publications/essays/archives/000385.php">Ajax</a> only part of the page is reloaded.</p>
      <p>From the <em>client side</em>, Ajax is substantially a Javascript, more or less complex, that simulates a browser without interface inside the browser you are using. The responses to the requests made by this pseudo-browser are interpreted by the script and translated in <em>live</em> changes to the page you are on.</p>
      <p>From the <em>server side</em>, Ajax is… nothing! The pseudo-browser makes standard requests and receives standard responses. You only need to request the right page at the right moment.</p>
      <h4>But…</h4>
      <p>My first idea for implementing Ajax on MT was hacking the Perl. The second one was writing a plugin. But reading MT’s code I had a surprise!</p>
      <p>From the file <strong>Comments.pm</strong> of MT library:</p>
      <pre><code># Form a link to the comment&#x000A;my $comment_link;&#x000A;if (!$q-&gt;param('static')) {&#x000A;    my $url = $app-&gt;base . $app-&gt;uri;&#x000A;    $url .= '?entry_id=' . $q-&gt;param('entry_id');&#x000A;    $url .= '&amp;static=0&amp;arch=1' if ($q-&gt;param('arch'));&#x000A;    $comment_link = $url;&#x000A;} else {&#x000A;    my $static = $q-&gt;param('static');&#x000A;    if ($static == 1) {&#x000A;        # I think what we really want is the individual archive.&#x000A;        $comment_link = $entry-&gt;permalink;&#x000A;    } else {&#x000A;        $comment_link = $static . '#' . $comment-&gt;id;&#x000A;    }&#x000A;}&#x000A;&#x000A;...&#x000A;&#x000A;return $app-&gt;redirect($comment_link);</code></pre>
      <p>That <code>static</code> parameter, which is almost ignored in <a href="http://www.sixapart.com/movabletype/docs/mtmanual_comments.html#comments">Movabletype documentation</a>, is the key of everything: <strong>if the request includes a parameter named <code>static</code> with value different from 1, the value of that parameter is used like an <span class="caps">URL</span> to redirect the user</strong>.</p>
      <p>The trick is all here. A little bit of Javascript makes the rest.</p>
      <h4>The client side</h4>
      <p>The Javascript is composed by 2 fundamental functions.</p>
      <pre><code>function initializeAjax() {&#x000A;  var s = false;&#x000A;  if (typeof XMLHttpRequest != 'undefined') {&#x000A;    s = new XMLHttpRequest();&#x000A;  }&#x000A;  else {&#x000A;    try {&#x000A;      s = new ActiveXObject("Msxml2.XMLHTTP");&#x000A;    }&#x000A;    catch (e) {&#x000A;      try {&#x000A;        s = new ActiveXObject("Microsoft.XMLHTTP");&#x000A;      }&#x000A;      catch (E) {&#x000A;        s = false;&#x000A;      }&#x000A;    }&#x000A;  }</code>&#x000A;&#x000A;<code>  return s;&#x000A;}</code></pre>
      <p><code>initializeAjax()</code> is the function that returns the <em>hidden browser</em>, which is a software object on which you can operate using a series of functions.</p>
      <pre><code>function sendComment(response_page) {</code>&#x000A;&#x000A;<code>  connection = initializeAjax();&#x000A;  if (!connection) {&#x000A;    return true;&#x000A;  }</code>&#x000A;&#x000A;<code>  var remember = "";&#x000A;  var forget = "";</code>&#x000A;&#x000A;<code>  var fields = document.getElementById("comments_form").elements;</code>&#x000A;&#x000A;<code>  fields["post"].setAttribute("disabled", "true");&#x000A;  fields["post"].setAttribute("value", "Processing...");</code>&#x000A;&#x000A;<code>  var requestText = '';&#x000A;  requestText += "author="+encodeURIComponent(fields["author"].value);&#x000A;  requestText += "&amp;entry_id="+encodeURIComponent(fields["entry_id"].value);&#x000A;  requestText += "&amp;email="+encodeURIComponent(fields["email"].value);&#x000A;  requestText += "&amp;url="+encodeURIComponent(fields["url"].value);&#x000A;  requestText += "&amp;text="+encodeURIComponent(fields["text"].value);&#x000A;  requestText += "&amp;static="+encodeURIComponent(response_page);&#x000A;  requestText += "&amp;post="+encodeURIComponent('POST');&#x000A;  if (fields["remember"] &amp;&amp; fields["remember"].checked==true) requestText += "&amp;remember="+encodeURIComponent(fields["remember"].value);&#x000A;  if (fields["forget"] &amp;&amp; fields["forget"].checked==true)   requestText += "&amp;forget="+encodeURIComponent(fields["forget"].value);</code>&#x000A;&#x000A;<code>  connection.open("POST","/cgi-bin/mt/mt-comments.cgi",true);&#x000A;  connection.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=UTF-8');&#x000A;  connection.setRequestHeader('Content-Length', requestText.length);</code>&#x000A;&#x000A;<code>  connection.onreadystatechange = function()&#x000A;  {&#x000A;    if (connection.readyState == 4) {&#x000A;      response = connection.responseText;&#x000A;      if ( (connection.status == 200 &amp;&amp; response != "invalid") &amp;&amp; !response.match(/&lt;html&gt;.*&lt;\/html&gt;/) &amp;&amp; !response.match(/&lt;meta[^&gt;]*&gt;/)) {&#x000A;        document.getElementById("comments").innerHTML = response;&#x000A;      }&#x000A;      else {&#x000A;        window.alert("Spiacente, ma non e' possibile processare ora il tuo commento. Prova piu' tardi, per favore...");&#x000A;        fields["post"].removeAttribute("disabled");&#x000A;        fields["post"].setAttribute("value", "Post");&#x000A;      }&#x000A;    }&#x000A;  }</code>&#x000A;&#x000A;<code>&#x000A;  connection.send(requestText);</code>&#x000A;&#x000A;<code>  return false;&#x000A;}</code></pre>
      <p><code>sendComment()</code> is the function that uses the object returned from <code>initializeAjax()</code> to send request to the server. Once the request is sent, the function waits for the response, that, if regular, is used used to modify the page. <code>sendComment()</code> is called when you send the form, using the <code>onsubmit</code> event of the <code>form</code> element.</p>
      <p><strong>The <code>requestText += "&amp;static="+encodeURIComponent(response_page);</code> is the trick: when you send the comment, the <a href="http://jpspan.sourceforge.net/wiki/doku.php?id=javascript:xmlhttprequest">XMLHttpRequest object</a> – the hidden browser – is redirected to a specific page (the <code>response_page</code> passed to function <code>sendComment()</code>).</strong></p>
      <h4>What page?</h4>
      <p>The <code>response_page</code> is a simple page, generated from MT using an individual template. For example, if you have the posts archived by date using <code>&lt;$MTArchiveDate format="%Y/%m/%d"$&gt;/&lt;$MTEntryTitle dirify="1"$&gt;.html</code> in the <a href="http://www.sixapart.com/movabletype/docs/mtmanual_weblog_config.html#item_Archive_File_Templates">Archive File Template</a>, you can create the <code>response_page</code> using a second individual archive with something like <code>&lt;$MTArchiveDate format="%Y/%m/%d"$&gt;/&lt;$MTEntryTitle dirify="1"$&gt;.ajax.html</code>. Being of individual type, this template is rebuild every time a comment is posted.</p>
      <p>This template generates the content used to substitute the part of the page interested by Ajax: in the case of comments, the <br>
      template could generate files containing the <span class="caps">HTML</span> code to use with <code>innerHTML</code> property of a <code>div</code> element (this is what is done here on sistrall.it).</p>
      <h4>And if there’s no Javascript?</h4>
      <p>If Javascript is not available for any reason, everything works just like Ajax doesn’t exists: the form is sent from the real browser, the <code>static</code> parameter takes the value 1 from an hidden field and MT redirects the user following the standard way.</p>
      <h4>Conclusions</h4>
      <p>That’s all: implementing Ajax enabled comments on MT isn’t difficult at all! The technique here explained is one of the simplest, but more can be done generating, for example, <code>response_page</code>s containing a real <span class="caps">XML</span> tree, using the content of different nodes to substitute more elements in the page.</p>
      </div>
      <div am-post--prev-next=""><div am-prev-next=""><div am-prev-next--prev=""><p><span am-prev-next--label>Prima</span> <a href="/thoughts/2005/05/13/opensource-freesoftware-e-la-crisi-it/">OpenSource, FreeSoftware e la crisi IT</a> <span am-prev-next--date>13 maggio 2005</span></p>
      </div>
      <div am-prev-next--next=""><p><span am-prev-next--label>Dopo</span> <a href="/thoughts/2005/05/26/brevetti-software-e-tortellini/">Brevetti software e tortellini</a> <span am-prev-next--date>26 maggio 2005</span></p>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
    </section>
    <footer>
      <div am-footer=""><div am-footer--container=""><div am-footer--links=""><div am-footer--social=""><h3>Gli altri me</h3>
      <ul>
        <li><a href="https://twitter.com/sistrall">Twitter</a></li>
        <li><a href="https://www.facebook.com/silvano.stralla">Facebook</a></li>
      </ul>
      </div>
      <div am-footer--photographs=""><h3>L'io immaginario</h3>
      <ul>
        <li><a href="https://www.flickr.com/photos/sistrall/">Flickr</a></li>
        <li><a href="http://instagram.com/sistrall">Instagram</a></li>
      </ul>
      </div>
      </div>
      <hr>
      <div am-footer--content=""><p>My name is Silvano Stralla. I’m webdesigner, developer and passionate photographer and I use this site to publish my photographs and my /s(c|p)ar(c|s)e/ thoughts. Feel free to contact me: find me on Twitter or drop an email to silvano.stralla at sistrall.it.</p>
      
      <p>This website and all of its content is property of the author
      © 2002—2015 (all rights reserved).</p>
      
      <p>Fatto a mano, con amore, a Torino.</p>
      </div>
      <div am-footer--deco=""><p><img src="/assets/images/liberty-deco.svg" /></p>
      </div>
      </div>
      </div>
    </footer>
  </body>
</html>
